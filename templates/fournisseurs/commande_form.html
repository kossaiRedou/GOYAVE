{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
{{ form.media.css }}
{{ formset.forms.0.media.css }}
{% endblock %}

{% block content %}

<div class="container py-4">
  <nav class="mb-4">
    <a class="me-3" href="{% url 'fournisseurs:liste' %}">Fournisseurs</a>
    <a class="me-3" href="{% url 'fournisseurs:commandes' %}">Commandes</a>
    <a class="me-3" href="{% url 'fournisseurs:receptions' %}">Réceptions</a>
    <a href="{% url 'fournisseurs:paiements' %}">Paiements</a>
  </nav>

  <h1>
    {% if form.instance.pk %}
      Modifier la commande #{{ form.instance.pk }}
    {% else %}
      Nouvelle commande
    {% endif %}
  </h1>

  <form method="post" novalidate>
    {% csrf_token %}

{{ form.as_p }}

<h2>Lignes de commande</h2>

{% if formset.non_form_errors %}
  <div class="alert alert-danger">
    {{ formset.non_form_errors }}
  </div>
{% endif %}

{{ formset.management_form }}
<table class="table table-hover">
  <thead>
    <tr>
      <th>Produit</th>
      <th>Quantité</th>
      <th>Prix achat</th>
      <th>Supprimer</th>
    </tr>
  </thead>
  <tbody>
    {% for fs in formset %}
      {% if fs.errors %}
        <tr>
          <td colspan="4">
            <ul class="text-danger">
              {% for error in fs.non_field_errors %}
                <li>{{ error }}</li>
              {% endfor %}
              {% for field in fs.visible_fields %}
                {% for error in field.errors %}
                  <li>{{ field.label }} : {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </td>
        </tr>
      {% endif %}
      <tr class="formset_row">
        {% for hidden in fs.hidden_fields %}
          {{ hidden }}
        {% endfor %}
        <td>{{ fs.produit }}</td>
        <td>{{ fs.quantite }}</td>
        <td>{{ fs.prix_achat }}</td>
        <td>{{ fs.DELETE }}</td>
      </tr>
    {% endfor %}
  </tbody>
</table>

    <div class="text-end mb-3">
      Total commande : <strong id="total-commande">0.00 €</strong>
    </div>

<button type="submit" class="btn btn-primary">
  {% if form.instance.pk %}Enregistrer{% else %}Créer{% endif %}
</button>
<a class="btn btn-secondary" href="{% url 'fournisseurs:commandes' %}">Annuler</a>
  </form>

  <!-- ============================ block js ================================== -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  <script src="{% static 'formset/jquery.formset.js' %}"></script>

  <script>
    $('.formset_row').formset({
      prefix: '{{ formset.prefix }}',
      addText: 'Ajouter une ligne',
      deleteText: 'Supprimer',
      formCssClass: 'formset_row'
    });
  </script>

  <!-- Script pour le calcul des totaux -->
  <script>
    $(document).ready(function() {
      // Fonction pour mettre à jour les totaux
      function updateTotal() {
        let total = 0;
        $('.formset_row:not(:hidden)').each(function() {
          const qte = parseFloat($(this).find('input[name$="-quantite"]').val()) || 0;
          const prix = parseFloat($(this).find('input[name$="-prix_achat"]').val()) || 0;
          const ligne_total = qte * prix;
          total += ligne_total;
        });
        $('#total-commande').text(total.toFixed(2) + ' €');
      }

      // Mettre à jour quand on change une quantité ou un prix
      $(document).on('input', 'input[name$="-quantite"], input[name$="-prix_achat"]', updateTotal);

      // Mettre à jour quand on ajoute ou supprime une ligne
      $(document).on('formAdded formDeleted', 'table', updateTotal);


      // Calcul initial
      updateTotal();
    });
  </script>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media.js }}
{{ formset.forms.0.media.js }}
{% endblock %}