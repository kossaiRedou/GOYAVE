{% extends 'base.html' %}
{% block content %}
<div class="container py-4">
  <nav class="mb-4">
    <a class="me-3" href="{% url 'fournisseurs:liste' %}">Fournisseurs</a>
    <a class="me-3" href="{% url 'fournisseurs:commandes' %}">Commandes</a>
    <a class="me-3" href="{% url 'fournisseurs:receptions' %}">Réceptions</a>
    <a href="{% url 'fournisseurs:paiements' %}">Paiements</a>
  </nav>

  <h1>Réception de la commande #{{ commande.pk }}</h1>

  <form method="post" novalidate id="reception-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <table class="table">
      <thead>
        <tr>
          <th>Produit</th>
          <th>Qté commandée</th>
          <th>Prix achat</th>
          <th>Quantité à recevoir</th>
          <th>Référence</th>
        </tr>
      </thead>
      <tbody>
        {% for form in formset.forms %}
        <tr>
          <td>
            {{ form.produit }}  {# champ caché #}
            {{ form.initial.produit_label }}
          </td>
          <td>{{ form.quantite_commandee.value }}</td>
          <td>
            {{ form.prix_achat }}
            {% for err in form.prix_achat.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </td>
          <td>
            {{ form.quantite_livree }}
            {% for err in form.quantite_livree.errors %}
              <div class="text-danger small">{{ err }}</div>
            {% endfor %}
          </td>
          <td>{{ form.reference }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <button type="submit" class="btn btn-primary">
      Enregistrer la réception
    </button>
    <a class="btn btn-secondary" href="{% url 'fournisseurs:commandes' %}">
      Annuler
    </a>
  </form>
</div>

{# --- Petit script JS pour bloquer côté client les dépassements --- #}
{% block extra_js %}
<script>
document.getElementById('reception-form').addEventListener('submit', function(ev){
  let invalid = false;
  
  // Validation des quantités
  document.querySelectorAll('input[name$="-quantite_livree"]').forEach(function(input){
    const qRecue = parseInt(input.value) || 0;
    const qCmd = parseInt(
      input.closest('tr').querySelector('td:nth-child(2)').innerText
    ) || 0;
    if(qRecue > qCmd){
      invalid = true;
      input.classList.add('is-invalid');
    } else {
      input.classList.remove('is-invalid');
    }
  });

  // Validation des prix d'achat
  document.querySelectorAll('input[name$="-prix_achat"]').forEach(function(input){
    const prix = parseFloat(input.value) || 0;
    if(prix <= 0){
      invalid = true;
      input.classList.add('is-invalid');
    } else {
      input.classList.remove('is-invalid');
    }
  });

  if(invalid){
    ev.preventDefault();
    alert("Veuillez vérifier les quantités et les prix saisis.");
  }
});
</script>
{% endblock %}
{% endblock %}
