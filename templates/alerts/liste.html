{% extends 'base.html' %}
{% load static %}

{% block title %}Alertes - {{ block.super }}{% endblock %}

{% block extra_css %}
<link href="{% static 'css/alerts.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
            <i class="fas fa-bell me-2"></i>Alertes
        </h1>
    </div>

    {% include 'alerts/partials/_filters.html' %}

    <form method="post">
        {% csrf_token %}
        <div class="card">
            {% include 'alerts/partials/_bulk_actions.html' %}

            <div class="list-group list-group-flush">
                {% for alert in alerts %}
                    {% include 'alerts/partials/_alert_item.html' with alert=alert %}
                {% empty %}
                <div class="list-group-item py-4 text-center text-muted">
                    <i class="fas fa-bell-slash fa-2x mb-3"></i>
                    <p class="mb-0">Aucune alerte à afficher</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </form>

    {% include 'alerts/partials/_pagination.html' %}
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Utiliser la délégation d'événements pour gérer les clics sur les boutons
    $(document).on('click', '.mark-read', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var button = $(this);
        var alertItem = button.closest('.alert-item');
        var alertId = alertItem.data('alert-id');
        
        $.post("{% url 'alerts:mark_read' 0 %}".replace('0', alertId), {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        }, function() {
            alertItem.fadeOut(function() {
                alertItem.removeClass('list-group-item-' + alertItem.data('color'));
                button.closest('.btn-group').html(
                    '<button type="button" class="btn btn-outline-warning mark-unread" title="Marquer comme non lu">' +
                    '<i class="fas fa-undo"></i></button>' +
                    '<button type="button" class="btn btn-outline-danger delete-alert" title="Supprimer">' +
                    '<i class="fas fa-times"></i></button>'
                );
                alertItem.fadeIn();
            });
        });
    });

    $(document).on('click', '.mark-unread', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var button = $(this);
        var alertItem = button.closest('.alert-item');
        var alertId = alertItem.data('alert-id');
        
        $.post("{% url 'alerts:mark_unread' 0 %}".replace('0', alertId), {
            'csrfmiddlewaretoken': '{{ csrf_token }}'
        }, function() {
            alertItem.fadeOut(function() {
                alertItem.addClass('list-group-item-' + alertItem.data('color'));
                button.closest('.btn-group').html(
                    '<button type="button" class="btn btn-outline-primary mark-read" title="Marquer comme lu">' +
                    '<i class="fas fa-check"></i></button>' +
                    '<button type="button" class="btn btn-outline-danger delete-alert" title="Supprimer">' +
                    '<i class="fas fa-times"></i></button>'
                );
                alertItem.fadeIn();
            });
        });
    });

    $(document).on('click', '.delete-alert', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var button = $(this);
        var alertItem = button.closest('.alert-item');
        var alertId = alertItem.data('alert-id');
        
        if (confirm('Voulez-vous vraiment supprimer cette alerte ?')) {
            $.post("{% url 'alerts:delete' 0 %}".replace('0', alertId), {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            }, function() {
                alertItem.fadeOut(function() {
                    alertItem.remove();
                    // Mettre à jour le compteur
                    var count = parseInt($('.text-muted').text());
                    $('.text-muted').text((count - 1) + ' alerte(s)');
                });
            });
        }
    });
});
</script>
{% endblock %}